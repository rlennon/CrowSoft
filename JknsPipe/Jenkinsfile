pipeline {
  agent any
options{
	timestamps()
	disableConcurrentBuilds()
	buildDiscarder(logRotator(numToKeepStr:'3', artifactNumToKeepStr :'6'))
	}
   tools{
        gradle  'gradle-4.10.2'
    }
    environment{
        BUILD_NUM = '$BUILD_NUMBER'
    }
  stages{
		stage('Artifactory Defined'){
			steps{
				rtGradleResolver(id: 'resolvecrosoft', serverId:'Art-Server-1')
				rtGradleDeployer(id:'deploycrosoft', serverId :'Art-Server-1')
			}
		}
		stage('Checkout'){
			step{
				checkout([$class: 'GitSCM' , branches:[[name: './CSoftDevBranch']], doGenerateSubmoduleConfitguraions: false, extensions: [],submoduleCfg: [], useRemoteConfigs:[[url: 'https://github.com/rlennon/CrowSoft.git']]])
			}
		}
	//	stage('Gradle Build'){
		///	steps{
			//	rtGradleRun(usePlugin: true, tool:'gradle-4.10.2', useWrapper: true, rootDor: '' , buildFile : 'build.gradle', resolverId: 'resolvecrosoft', deployerId: 'deploycrosoft' )
			//sh 'rtGradleRun'
		//	}
	//	}
	stage ('Build MVC'){
		steps {
			echo 'This step runs MSBuild.'
			//sh "cd Projects/crowsoftmvc"
			//sh "dotnet build"
			//sh "cd /var/lib/jenkins/workspace/test_pipeline@script/Projects/crowsoftmvc"
			}
		}
		
	stage ('Build Unit Test') {
		steps {
			echo 'This step runs Unit test.'
			//sh "cd Projects/crowsoft_unittests"
			//sh "dotnet test"
			//sh "cd /var/lib/jenkins/workspace/test_pipeline@script/Projects/crowsoft_unittests"
			}
		}
		//stage ('SonarQube'){
		//	steps{
			//	script{
				//	def scannerhome= tool 'csoftsonar';
				//	withSonarQubeEnv('csoftsonar'){
				//		sh ''' ${scannerhome}/bin/linux-x86-64   -D sonar.login= sonar  -D sonar.password=sonarcsoft'''
				//	}
			//	}
				
		//	}
		//}
		
    stage ('Run Selenium Test') {
	  	steps {
		  	echo 'This step runs Selenium Test.'
			}
		}	
		
		stage ('Artifactory package') {
			steps {
			    rtGradleResolver(id:"resolvecrosoft", serverId :"Art-Server-1")

			}
		}	
		
	 stage('Ansible stop publish and restart') {
	  	steps {	
			sshagent(['dev']) {
				sh label: '', script: 'ansible devadmin@172.28.25.133 -a "sudo systemctl stop crowsoft-webapp.service" '
				//sh label: '', script: 'ansible devadmin@172.28.25.133 -a "sudo pwd" '
				//sh label: '', script: 'ansible devadmin@172.28.25.133 -a "sudo cd /dev" '
				//sh label: '', script: 'ansible devadmin@172.28.25.133 -a "sudo mkdir "pkgbk.$(date +"%d%m%y%s")" " '
				//sh label: '', script: 'ansible devadmin@172.28.25.133 -a "sudo mv c* "pkgbk.$(date +"%d%m%y%s")" " '
				//sh label: '', script: 'ansible devadmin@172.28.25.133 -a "sudo rm -r Projects " '
				//sh label: '', script: 'ansible devadmin@172.28.25.133 -a "sudo chmod 766 projects.zip " '
				//sh label: '', script: 'ansible devadmin@172.28.25.133 -a "sudo unzip projects.zip " '
				//sh label: '', script: 'ansible devadmin@172.28.25.133 -a "sudo cd /Projects " '
				//sh label: '', script: 'ansible devadmin@172.28.25.133 -a "sudo mv  /home/devadmin/dev/Projects/crow* /home/devadmin/dev " '
				//sh label: '', script: 'ansible devadmin@172.28.25.133 -a "sudo dotnet publish /home/devadmin/dev/crowsoftmvc/crowsoftmvc.csproj –c release -o /var/www/crowsoftwww " '
				sh label: '', script: 'ansible devadmin@172.28.25.133 -a "sudo systemctl start crowsoft-webapp.service " '
								
				}
			}
 		}
	 
	}
}

